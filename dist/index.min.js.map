{"version":3,"sources":["../dev/index.js"],"names":["PNGArrays","[object Object]","array","alpha","file","constructor","Uint8ClampedArray","this","prepareExportData","height","Math","ceil","length","Promise","resolve","reject","PNG","pngjs2","width","imgData","data","Buffer","from","i","opti","optipng","pngStream","pack","writeStream","fs","createWriteStream","replace","pipe","on","canvas","document","createElement","context","getContext","getImageData","putImageData","createReadStream","filterType","stringRepresentation","pixelString","c","toString","padStart","values","split","shift","hexToNum","prepareImportData","remainder","parts","numToHex","match","p","push","parseInt","img","drawImage","hex","undefined","positive","valuesIn","leadingDecZeroes","slice","left","right","repeat","parseFloat","num","sign","test","toFixed","cap","min","rightString","exec","final","window","exports","require"],"mappings":"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","file":"index.min.js","sourcesContent":["\"use strict\"\r\n\r\nclass PNGArrays {\r\n\r\n    /*\r\n        TODO\r\n\r\n        - test the alpha functionality (and add more tests, in general)\r\n\r\n        - short/big numbers optimization, to allow storing larger numbers\r\n            - normal: limit of 7 digits on the left hand side of the decimal place\r\n            - long: limit of 127 digits (by using an additional character for storing metadata)\r\n    */\r\n\r\n    static toPNG (array, {alpha=false, file=false}={}) {\r\n\r\n        // Convert the array values to Uint8Clamped values (Base 15 with 16th value used as metadata)\r\n        array = array.constructor == Uint8ClampedArray ? array : this.prepareExportData(array)\r\n\r\n        const width = 1000 // TODO, calculate or configure value for this\r\n        const height = Math.ceil((array.length/(alpha ? 4 : 3)) / width)\r\n\r\n        // Write to file\r\n        if (file) {\r\n            return new Promise((resolve, reject) => {\r\n\r\n                const PNG = new this.pngjs2({width, height})\r\n                const imgData = new Uint8ClampedArray(array.length/3*4)\r\n\r\n                if (alpha) {\r\n                    PNG.data = Buffer.from(array)\r\n                } else {\r\n                    for (let i=0; i<array.length/3; i++) {\r\n                        imgData[i*4]   = array[i*3]\r\n                        imgData[i*4+1] = array[i*3+1]\r\n                        imgData[i*4+2] = array[i*3+2]\r\n                        imgData[i*4+3] = 255\r\n                    }\r\n                    PNG.data = Buffer.from(imgData)\r\n                }\r\n\r\n                const opti = new this.optipng([\"-o7\"])\r\n                const pngStream = PNG.pack()\r\n                const writeStream = this.fs.createWriteStream(file.replace(/\\.png$/, \"\")+\".png\")\r\n\r\n                pngStream.pipe(opti).pipe(writeStream)\r\n                writeStream.on(\"end\", () => resolve())\r\n            })\r\n\r\n        } else {\r\n            // Draw to canvas\r\n            const canvas = document.createElement(\"canvas\")\r\n            canvas.width = width\r\n            canvas.height = height\r\n            const context = canvas.getContext(\"2d\")\r\n\r\n            const imgData = context.getImageData(0, 0, canvas.width, canvas.height)\r\n\r\n            if (alpha) {\r\n                context.putImageData(array, 0, 0)\r\n            } else {\r\n                for (let i=0; i<array.length/3; i++) {\r\n                    imgData.data[i*4]   = array[i*3]\r\n                    imgData.data[i*4+1] = array[i*3+1]\r\n                    imgData.data[i*4+2] = array[i*3+2]\r\n                    imgData.data[i*4+3] = 255\r\n                }\r\n                context.putImageData(imgData, 0, 0)\r\n            }\r\n\r\n            return canvas\r\n        }\r\n    }\r\n\r\n    static fromPNG (data, {alpha=false}={}) {\r\n\r\n        // Read from file\r\n        if (typeof data == \"string\") {\r\n            return new Promise((resolve, reject) => {\r\n                const rs = this.fs.createReadStream(data)\r\n\r\n                rs.pipe(new this.pngjs2({filterType: 4}))\r\n                .on(\"parsed\", function () {\r\n\r\n                    let stringRepresentation = \"\"\r\n\r\n                    for (let i=0; i<this.data.length/4; i++) {\r\n\r\n                        let pixelString = \"\"\r\n\r\n                        if (alpha) {\r\n                            for (let c=0; c<4; c++) {\r\n                                pixelString += this.data[i*4+c].toString(16).padStart(2, 0)\r\n                            }\r\n                        } else {\r\n                            for (let c=0; c<3; c++) {\r\n                                pixelString += this.data[i*4+c].toString(16).padStart(2, 0)\r\n                            }\r\n                        }\r\n\r\n                        stringRepresentation += pixelString\r\n                    }\r\n\r\n                    const values = stringRepresentation.split(\"f\")\r\n                    values.shift()\r\n\r\n                    for (let i=0; i<values.length; i++) {\r\n                        values[i] = PNGArrays.hexToNum(values[i])\r\n                    }\r\n\r\n                    resolve(values)\r\n                })\r\n            })\r\n        } else {\r\n            data = data.constructor == Uint8ClampedArray ? data : this.prepareImportData(data)\r\n\r\n            let stringRepresentation = \"\"\r\n\r\n            for (let i=0; i<data.length/4; i++) {\r\n\r\n                let pixelString = \"\"\r\n\r\n                if (alpha) {\r\n                    for (let c=0; c<4; c++) {\r\n                        pixelString += data[i*4+c].toString(16).padStart(2, 0)\r\n                    }\r\n                } else {\r\n                    for (let c=0; c<3; c++) {\r\n                        pixelString += data[i*4+c].toString(16).padStart(2, 0)\r\n                    }\r\n                }\r\n\r\n                stringRepresentation += pixelString\r\n            }\r\n\r\n            const values = stringRepresentation.split(\"f\")\r\n            values.shift()\r\n\r\n            for (let i=0; i<values.length; i++) {\r\n                values[i] = this.hexToNum(values[i])\r\n            }\r\n\r\n            return values\r\n        }\r\n    }\r\n\r\n\r\n    // Helper functions\r\n    static prepareExportData (array) {\r\n\r\n        const data = []\r\n        let remainder = \"\"\r\n\r\n        for (let i=0; i<array.length; i++) {\r\n\r\n            // Convert value to base15\r\n            const base = remainder + this.numToHex(array[i])\r\n            const parts = base.match(/.{1,2}/g)\r\n            const length = parts.length\r\n\r\n            for (let p=0; p<length; p++) {\r\n                if (parts[0].length==2) {\r\n                    data.push(parseInt(`0x${parts.shift()}`))\r\n                }\r\n            }\r\n\r\n            remainder = parts[0] || \"\"\r\n        }\r\n\r\n        while (data.length%3) {\r\n            data.push(0)\r\n        }\r\n\r\n        return new Uint8ClampedArray(data)\r\n    }\r\n\r\n    static prepareImportData (img) {\r\n        const canvas = document.createElement(\"canvas\")\r\n        canvas.height = img.height\r\n        canvas.width = img.width\r\n        const context = canvas.getContext(\"2d\")\r\n        context.drawImage(img, 0, 0)\r\n        return context.getImageData(0, 0, canvas.width, canvas.height).data\r\n    }\r\n\r\n    static hexToNum (hex) {\r\n\r\n        if (hex==\"00000\") {\r\n            return 0\r\n        }\r\n\r\n        if (hex===undefined) {\r\n            return 0\r\n        }\r\n\r\n        const positive = parseInt(hex[0], 16) >= 7\r\n        const valuesIn = parseInt(hex[0], 15) - (positive ? 6 : -1)\r\n        const leadingDecZeroes = parseInt(hex.slice(1, 3), 15)\r\n        const left = hex.slice(3, 3+valuesIn)\r\n        let right = \"\"\r\n\r\n        if (left.length+3 < hex.length) {\r\n            right = \".\"+\"0\".repeat(leadingDecZeroes)+parseInt(hex.slice(3+valuesIn, hex.length), 15)\r\n        }\r\n\r\n        return (positive ? 1 : -1) * parseFloat(parseInt(left, 15)+right)\r\n    }\r\n\r\n    static numToHex (num) {\r\n\r\n        const positive = num > 0\r\n        let sign = num > 0 ? 7 : 0\r\n        let leadingDecZeroes = \"00\"\r\n\r\n        // Number is not an integer\r\n        if (num !== parseInt(num)) {\r\n\r\n            // Discard values below 17 decimal places\r\n            if (/\\.0{17}$/.test(num.toFixed(17))) {\r\n                return \"F\"+sign.toString(15)+\"0000\"\r\n            }\r\n\r\n            // The left part is capped\r\n            const cap = 2562890624\r\n            const left = Math.min(parseInt(num), cap).toString(15)\r\n            const rightString = num.toString().split(\".\")[1]\r\n\r\n            leadingDecZeroes = Math.min(/^0*/.exec(rightString)[0].length, 15).toString(15).padStart(2, 0)\r\n            const right = parseInt(rightString).toString(15)\r\n\r\n\r\n            sign += left.length-1\r\n\r\n            let final = \"F\"+sign.toString(15)+leadingDecZeroes+left+right\r\n\r\n            if (final.length%2!=0) {\r\n                final = \"F\"+sign.toString(15)+leadingDecZeroes+\"0\"+left+right\r\n            }\r\n\r\n            return final\r\n        }\r\n\r\n        sign += num.toString().length\r\n        let final = \"F\"+sign.toString(15)+leadingDecZeroes+num.toString(15)\r\n\r\n        if (final.length%2!=0) {\r\n            final = \"F\"+sign.toString(15)+leadingDecZeroes+\"0\"+num.toString(15)\r\n        }\r\n\r\n        return final\r\n    }\r\n\r\n}\r\n\r\n\r\n// https://github.com/DanRuta/jsNet/issues/33\r\n/* istanbul ignore next */\r\nif (typeof window != \"undefined\") {\r\n    window.exports = window.exports || {}\r\n    window.PNGArrays = PNGArrays\r\n} else {\r\n    PNGArrays.fs = require(\"fs\")\r\n    PNGArrays.pngjs2 = require(\"pngjs2\").PNG\r\n    PNGArrays.optipng = require(\"optipng\")\r\n}\r\nexports.PNGArrays = PNGArrays"]}